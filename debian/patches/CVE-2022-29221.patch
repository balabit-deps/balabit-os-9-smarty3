Backport of: 4eb86a67701301c38ed763b5ff5d251999adb491
From: Simon Wisselink <s.wisselink@iwink.nl>
Date: Mon, 16 May 2022 12:34:49 +0200
Subject: [PATCH 1/2] Replace '*/' in user supplied input in C-style comments
 with '* /'.
---
 libs/sysplugins/smarty_internal_compile_block.php      |  4 ++--
 libs/sysplugins/smarty_internal_compile_function.php   |  8 ++++----
 libs/sysplugins/smarty_internal_compile_include.php    |  4 ++--
 .../smarty_internal_config_file_compiler.php           | 10 ++++++----
 libs/sysplugins/smarty_internal_runtime_codeframe.php  |  9 ++++++---
 .../smarty_internal_templatecompilerbase.php           |  4 ++++
 6 files changed, 24 insertions(+), 15 deletions(-)
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_block.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_compile_block.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_block.php
@@ -125,7 +125,7 @@ class Smarty_Internal_Compile_Blockclose
         // setup buffer for template function code
         $compiler->parser->current_buffer = new Smarty_Internal_ParseTree_Template();
         $output = "<?php\n";
-        $output .= "/* {block {$_name}} */\n";
+        $output .= $compiler->cStyleComment(" {block {$_name}} ") . "\n";
         $output .= "class {$_className} extends Smarty_Internal_Block\n";
         $output .= "{\n";
         foreach ($_block as $property => $value) {
@@ -155,7 +155,7 @@ class Smarty_Internal_Compile_Blockclose
         }
         $output .= "}\n";
         $output .= "}\n";
-        $output .= "/* {/block {$_name}} */\n\n";
+        $output .= $compiler->cStyleComment(" {/block {$_name}} ") . "\n\n";
         $output .= "?>\n";
         $compiler->parser->current_buffer->append_subtree(
             $compiler->parser,
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_function.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_compile_function.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_function.php
@@ -134,7 +134,7 @@ class Smarty_Internal_Compile_Functioncl
         if ($compiler->template->compiled->has_nocache_code) {
             $compiler->parent_compiler->tpl_function[ $_name ][ 'call_name_caching' ] = $_funcNameCaching;
             $output = "<?php\n";
-            $output .= "/* {$_funcNameCaching} */\n";
+            $output .= $compiler->cStyleComment(" {$_funcNameCaching} ") . "\n";
             $output .= "if (!function_exists('{$_funcNameCaching}')) {\n";
             $output .= "function {$_funcNameCaching} (Smarty_Internal_Template \$_smarty_tpl,\$params) {\n";
             $output .= "ob_start();\n";
@@ -159,7 +159,7 @@ class Smarty_Internal_Compile_Functioncl
             $output .= "/*/%%SmartyNocache:{$compiler->template->compiled->nocache_hash}%%*/\";\n?>";
             $output .= "<?php echo str_replace('{$compiler->template->compiled->nocache_hash}', \$_smarty_tpl->compiled->nocache_hash ?? '', ob_get_clean());\n";
             $output .= "}\n}\n";
-            $output .= "/*/ {$_funcName}_nocache */\n\n";
+            $output .= $compiler->cStyleComment("/ {$_funcName}_nocache ") . "\n\n";
             $output .= "?>\n";
             $compiler->parser->current_buffer->append_subtree(
                 $compiler->parser,
@@ -179,7 +179,7 @@ class Smarty_Internal_Compile_Functioncl
         }
         $compiler->parent_compiler->tpl_function[ $_name ][ 'call_name' ] = $_funcName;
         $output = "<?php\n";
-        $output .= "/* {$_funcName} */\n";
+        $output .= $compiler->cStyleComment(" {$_funcName} ") . "\n";
         $output .= "if (!function_exists('{$_funcName}')) {\n";
         $output .= "function {$_funcName}(Smarty_Internal_Template \$_smarty_tpl,\$params) {\n";
         $output .= $_paramsCode;
@@ -196,7 +196,7 @@ class Smarty_Internal_Compile_Functioncl
         );
         $compiler->parser->current_buffer->append_subtree($compiler->parser, $_functionCode);
         $output = "<?php\n}}\n";
-        $output .= "/*/ {$_funcName} */\n\n";
+        $output .= $compiler->cStyleComment("/ {$_funcName} ") . "\n\n";
         $output .= "?>\n";
         $compiler->parser->current_buffer->append_subtree(
             $compiler->parser,
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_include.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_compile_include.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_compile_include.php
@@ -318,14 +318,14 @@ class Smarty_Internal_Compile_Include ex
             }
             // get compiled code
             $compiled_code = "<?php\n\n";
-            $compiled_code .= "/* Start inline template \"{$sourceInfo}\" =============================*/\n";
+            $compiled_code .= $compiler->cStyleComment(" Start inline template \"{$sourceInfo}\" =============================") . "\n";
             $compiled_code .= "function {$tpl->compiled->unifunc} (Smarty_Internal_Template \$_smarty_tpl) {\n";
             $compiled_code .= "?>\n" . $tpl->compiler->compileTemplateSource($tpl, null, $compiler->parent_compiler);
             $compiled_code .= "<?php\n";
             $compiled_code .= "}\n?>\n";
             $compiled_code .= $tpl->compiler->postFilter($tpl->compiler->blockOrFunctionCode);
             $compiled_code .= "<?php\n\n";
-            $compiled_code .= "/* End inline template \"{$sourceInfo}\" =============================*/\n";
+            $compiled_code .= $compiler->cStyleComment(" End inline template \"{$sourceInfo}\" =============================") . "\n";
             $compiled_code .= '?>';
             unset($tpl->compiler);
             if ($tpl->compiled->has_nocache_code) {
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_config_file_compiler.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_config_file_compiler.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_config_file_compiler.php
@@ -157,10 +157,12 @@ class Smarty_Internal_Config_File_Compil
             $this->smarty->_debug->end_compile($this->template);
         }
         // template header code
-        $template_header =
-            "<?php /* Smarty version " . Smarty::SMARTY_VERSION . ", created on " . date("Y-m-d H:i:s") .
-            "\n";
-        $template_header .= "         compiled from '{$this->template->source->filepath}' */ ?>\n";
+        $template_header = sprintf(
+            "<?php /* Smarty version %s, created on %s\n         compiled from '%s' */ ?>\n",
+            Smarty::SMARTY_VERSION,
+            date("Y-m-d H:i:s"),
+            str_replace('*/', '* /' , $this->template->source->filepath)
+        );
         $code = '<?php $_smarty_tpl->smarty->ext->configLoad->_loadConfigVars($_smarty_tpl, ' .
                 var_export($this->config_data, true) . '); ?>';
         return $template_header . $this->template->smarty->ext->_codeFrame->create($this->template, $code);
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_runtime_codeframe.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_runtime_codeframe.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_runtime_codeframe.php
@@ -44,9 +44,12 @@ class Smarty_Internal_Runtime_CodeFrame
             $properties[ 'file_dependency' ] = $_template->cached->file_dependency;
             $properties[ 'cache_lifetime' ] = $_template->cache_lifetime;
         }
-        $output = "<?php\n";
-        $output .= "/* Smarty version {$properties[ 'version' ]}, created on " . date("Y-m-d H:i:s") .
-                   "\n  from '" . str_replace('*/', '* /', $_template->source->filepath) . "' */\n\n";
+        $output = sprintf(
+            "<?php\n/* Smarty version %s, created on %s\n  from '%s' */\n\n",
+            $properties[ 'version' ],
+            date("Y-m-d H:i:s"),
+            str_replace('*/', '* /', $_template->source->filepath)
+        );
         $output .= "/* @var Smarty_Internal_Template \$_smarty_tpl */\n";
         $dec = "\$_smarty_tpl->_decodeProperties(\$_smarty_tpl, " . var_export($properties, true) . ',' .
                ($cache ? 'true' : 'false') . ')';
Index: smarty3-3.1.39/libs/sysplugins/smarty_internal_templatecompilerbase.php
===================================================================
--- smarty3-3.1.39.orig/libs/sysplugins/smarty_internal_templatecompilerbase.php
+++ smarty3-3.1.39/libs/sysplugins/smarty_internal_templatecompilerbase.php
@@ -1455,6 +1455,10 @@ abstract class Smarty_Internal_TemplateC
      */
     abstract protected function doCompile($_content, $isTemplateSource = false);
 
+    public function cStyleComment($string) {
+        return '/*' . str_replace('*/', '* /' , $string) . '*/';
+    }
+
     /**
      * Compile Tag
      *
