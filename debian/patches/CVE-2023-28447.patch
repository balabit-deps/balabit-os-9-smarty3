Description: CVE-2023-28447 - potential arbitrary code execution in victim's browser
Origin: https://github.com/smarty-php/smarty/commit/7677db7bc9a1dcfcad1435fc9d3bac3f295ca3ad
Bug: https://github.com/smarty-php/smarty/security/advisories/GHSA-7j98-h7fp-4vwj
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1033964
From 7677db7bc9a1dcfcad1435fc9d3bac3f295ca3ad Mon Sep 17 00:00:00 2001
From: Simon Wisselink <s.wisselink@iwink.nl>
Date: Fri, 24 Mar 2023 12:19:34 +0100
Subject: [PATCH] Implement fix and tests

---
 libs/plugins/modifier.escape.php              |  4 +++-
 libs/plugins/modifiercompiler.escape.php      |  4 +++-
 .../PluginModifierEscapeTest.php              | 21 +++++++++++++++++++
 .../Operators/templates_c/.gitignore          |  2 ++
 4 files changed, 29 insertions(+), 2 deletions(-)
 create mode 100644 tests/UnitTests/TemplateSource/ValueTests/Operators/templates_c/.gitignore

--- a/libs/plugins/modifier.escape.php
+++ b/libs/plugins/modifier.escape.php
@@ -176,7 +176,8 @@ function smarty_modifier_escape($string,
             return $return;
         case 'javascript':
             // escape quotes and backslashes, newlines, etc.
-            return strtr(
+            $_ret =
+              strtr(
                 $string,
                 array(
                     '\\' => '\\\\',
@@ -184,9 +185,16 @@ function smarty_modifier_escape($string,
                     '"'  => '\\"',
                     "\r" => '\\r',
                     "\n" => '\\n',
-                    '</' => '<\/'
+                    '</' => '<\/',
+                    // see https://html.spec.whatwg.org/multipage/scripting.html#restrictions-for-contents-of-script-elements
+                    '<!--' => '<\!--',
+                    '<s'   => '<\s',
+                    '<S'   => '<\S',
+                    "`" => "\\\\`",
+                    "\${" => "\\\\\\$\\{"
                 )
             );
+            return $_ret;
         case 'mail':
             if (Smarty::$_MBSTRING) {
                 if (!$is_loaded_2) {
--- a/libs/plugins/modifiercompiler.escape.php
+++ b/libs/plugins/modifiercompiler.escape.php
@@ -91,7 +91,9 @@ function smarty_modifiercompiler_escape(
                 // escape quotes and backslashes, newlines, etc.
                 return 'strtr(' .
                        $params[ 0 ] .
-                       ', array("\\\\" => "\\\\\\\\", "\'" => "\\\\\'", "\"" => "\\\\\"", "\\r" => "\\\\r", "\\n" => "\\\n", "</" => "<\/" ))';
+                       ', array("\\\\" => "\\\\\\\\", "\'" => "\\\\\'", "\"" => "\\\\\"", "\\r" => "\\\\r", 
+                       "\\n" => "\\\n", "</" => "<\/", "<!--" => "<\!--", "<s" => "<\s", "<S" => "<\S",
+                       "`" => "\\\\`", "\${" => "\\\\\\$\\{"))';
         }
     } catch (SmartyException $e) {
         // pass through to regular plugin fallback
--- /dev/null
+++ b/tests/UnitTests/TemplateSource/ValueTests/Operators/templates_c/.gitignore
@@ -0,0 +1,2 @@
+# Ignore anything in here, but keep this directory
+*
