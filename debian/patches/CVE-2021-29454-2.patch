Backport of: 059bea274cf50524c4c972954f0404b2e586ea3d Mon Sep 17 00:00:00 2001
From: Claas Augner <github@caugner.de>
Date: Tue, 18 Jan 2022 00:10:17 +0100
Subject: [PATCH] Support multiple operators in math equations (#708)

* fix(math): fix equation regexp

Fixes #702.
---
diff --git a/libs/plugins/function.math.php b/libs/plugins/function.math.php
index 442b04c78..fd5b3d166 100644
--- a/libs/plugins/function.math.php
+++ b/libs/plugins/function.math.php
@@ -70,7 +70,7 @@ function smarty_function_math($params, $template)
     $number = '(?:\d+(?:[,.]\d+)?|pi|Ï€)'; // What is a number
     $functionsOrVars = '((?:0x[a-fA-F0-9]+)|([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*))';
     $operators = '[+\/*\^%-]'; // Allowed math operators
-    $regexp = '/^(('.$number.'|'.$functionsOrVars.'|('.$functionsOrVars.'\s*\((?1)+\)|\((?1)+\)))(?:'.$operators.'(?2))?)+$/';
+    $regexp = '/^(('.$number.'|'.$functionsOrVars.'|('.$functionsOrVars.'\s*\((?1)+\)|\((?1)+\)))(?:'.$operators.'(?1))?)+$/';
 
     if (!preg_match($regexp, $equation)) {
         trigger_error("math: illegal characters", E_USER_WARNING);
